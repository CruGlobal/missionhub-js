angular.module("missionhub").constant("config",{baseUrl:"https://stage.missionhub.com/apis/v3/"}).factory("api",function(n,r,e,t,i,a,o,s){function u(){return t.token()}function c(){return a.person(p.currentPersonId)}function l(r){if(!r)return o.organization(p.currentOrgId);var e=["admins","users","surveys","labels","questions","interaction_types"];return m({id:r.id,include:e.join(),organization_id:r.id}).then(function(r){var e=r.organization;o.organization(e),p.currentOrgId!=e.id&&(p.currentOrgId=e.id,n.$broadcast("current-org-updated",e))},function(n){alert("Organization change failed because: "+n.statusText)})}function d(){var n=["all_organization_and_children","all_organizational_permissions","user","organizational_permission","permission","organizational_labels","label","interactions","email_addresses","phone_numbers","addresses"],r=e.defer();return g({id:"me",include:n.join()}).then(function(n){var e=n.person;p.currentPersonId=e.id,a.person(e),s.list(e.all_organization_and_children),l({id:e.user.primary_organization_id}).then(function(){r.resolve(e)},function(n){r.reject(n)})},function(n){alert("Requesting your data failed due to: "+n),r.reject(n)}),r.promise}function g(n){var r=h("people",n);return r.then(function(n){angular.forEach(n.people,function(n){a.person(n)})}),r}function f(n){return h("interactions",n)}function m(n){return h("organizations",n)}var p=this,h=function(n,a){if(t.token())return p.currentOrgId&&"organizations"!==n&&angular.extend(a,{organization_id:p.currentOrgId}),r(i.baseUrl+n+"/:id",{id:"@id",facebook_token:u()}).get(a).$promise;var o=e.defer();return o.resolve({endpoint:[]}),o.promise};return{currentPerson:c,currentOrg:l,getMe:d,people:{get:g},interactions:{get:f},organizations:{get:m}}}).factory("loginDetails",function(){function n(n){return void 0===n?localStorage.getItem(r):void(n?localStorage.setItem(r,n):localStorage.removeItem(r))}var r="facebook_token";return{token:n}}),angular.module("missionhub").factory("personCache",function(){function n(n){return n.id?(r[n.id]=r[n.id]||{},angular.merge(r[n.id],n),!0):r[n]}var r={};return{person:n}}).factory("organizationCache",function(){function n(n){return n.id?(r[n.id]=r[n.id]||{},angular.merge(r[n.id],n),!0):r[n]}var r={};return{organization:n}}).factory("organizationListCache",function(){function n(n){return n&&n.length?0==n.length?0==r.length:(r=[],angular.merge(r,n),!0):angular.extend([],r)}var r=[];return{list:n}}),angular.module("missionhub").filter("interactionPrimaryInitiator",function(){return function(n){return n?n.initiators[0]?n.initiators[0]:n.creator?n.creator:{}:{}}}),angular.module("missionhub").filter("personAvatar",function(){return function(n,r){if(r=r||40,!n||!n.first_name)return"";if(n.picture)return n.picture+"?width="+r+"&height="+r;for(var e="444444",t=0,i=0;t<n.first_name.length;i=n.first_name.charCodeAt(t++)+((i<<5)-i));for(var t=0,e="";3>t;e+=("00"+(i>>8*t++&255).toString(16)).slice(-2));return"https://avatars.discourse.org/letter/"+n.first_name.slice(0,1)+"/"+e+"/"+r+".png"}}).filter("personPrimaryPhone",function(){return function(n){if(!n||!n.phone_numbers||0==n.phone_numbers.length)return"";for(var r=0;r<n.phone_numbers.length;){if(n.phone_numbers[r].primary)return n.phone_numbers[r].number;r++}return n.phone_numbers[0].number}}).filter("personFullname",function(){return function(n){return n&&n.first_name?n.first_name+" "+n.last_name:""}}),angular.module("missionhub").filter("backgroundStyle",function(){return function(n){return"background-image: url("+n+")"}}).filter("tel",function(){return function(n){if(!n)return"";var r=n.toString().trim().replace(/^\+/,"");if(r.match(/[^0-9]/))return n;var e,t,i;switch(r.length){case 10:e=1,t=r.slice(0,3),i=r.slice(3);break;case 11:e=r[0],t=r.slice(1,4),i=r.slice(4);break;case 12:e=r.slice(0,3),t=r.slice(3,5),i=r.slice(5);break;default:return n}return 1==e&&(e=""),i=i.slice(0,3)+"-"+i.slice(3),(e+" ("+t+") "+i).trim()}}).filter("googleMapsAddress",function(){return function(n){return mailingAddress="http://maps.google.com/maps?q=",n.address1&&(mailingAddress+=n.address1+"+"),n.address2&&(mailingAddress+=n.address2+"+"),n.city&&(mailingAddress+=n.city+",+"),n.state&&(mailingAddress+=n.state+"+"),n.country&&(mailingAddress+=n.country),mailingAddress.lastIndexOf("+")==mailingAddress.length-1&&(mailingAddress=mailingAddress.slice(0,-1)),mailingAddress}});